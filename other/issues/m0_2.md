# M0‑2

**Milestone:** M0 — Scaffold & MVP Endpoints
**Labels:** `type:ci`, `type:chore`, `area:container`, `priority:P1`

---

## Description

Containerize the ASP.NET Core API (.NET **9.0**) with a small, reproducible multi‑stage Dockerfile, add a sane `.dockerignore`, optional `docker compose` for local runs, and update the README to replace the placeholder. 

**Definition of Done**

* Image builds locally from the repo root.
* Container runs and serves on **:8080** when started with `ASPNETCORE_URLS=http://+:8080`.
* `docker compose up` starts the service the same way.
* README Quickstart updated with the real Docker run/compose commands.
* (Optional) CI workflow builds the image on PR (no push).

---

## Tasks

1. **Add Dockerfile** at `ops/Dockerfile` (multi‑stage):

   ```dockerfile
   # syntax=docker/dockerfile:1

   FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
   WORKDIR /src

   # copy solution + project for restore-layer caching
   COPY GameOps.sln ./
   COPY src/App/App.csproj src/App/
   RUN dotnet restore src/App/App.csproj

   # copy the rest and publish
   COPY . .
   RUN dotnet publish src/App/App.csproj -c Release -o /out -p:UseAppHost=false --no-restore

   FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS runtime
   WORKDIR /app
   COPY --from=build /out ./
   ENV ASPNETCORE_URLS=http://+:8080 \
       DOTNET_EnableDiagnostics=0
   EXPOSE 8080
   ENTRYPOINT ["dotnet", "App.dll"]
   ```

2. **Add `.dockerignore`** at repo root:

   ```gitignore
   **/bin/
   **/obj/
   .git
   .github
   .vscode
   .idea
   *.user
   *.suo
   *.log
   docker-compose.yml
   compose.yaml
   ```

3. **Add Compose file** (choose one name; here `compose.yaml`) at repo root:

   ```yaml
   services:
     app:
       build:
         context: .
         dockerfile: ops/Dockerfile
       environment:
         ASPNETCORE_URLS: http://+:8080
       ports:
         - "8080:8080"
       restart: unless-stopped
   ```

4. **README update** (`README.md`):

   * Replace the Docker placeholder with the real commands:

     ```bash
     # build
     docker build -t gameops/app:dev -f ops/Dockerfile .
     # run
     docker run --rm -p 8080:8080 -e ASPNETCORE_URLS=http://+:8080 gameops/app:dev
     ```
   * Add a short **Compose** section:

     ```bash
     docker compose up --build -d
     docker compose logs -f app
     ```

5. (Optional) **CI job to validate Docker build**: create `.github/workflows/docker.yml`:

   ```yaml
   name: Docker Build (PR)
   on:
     pull_request:
       branches: [ main ]
       paths:
         - "src/**"
         - "ops/Dockerfile"
         - "compose.yaml"
         - "docker-compose.yml"
         - "global.json"
   jobs:
     build:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v4
         - uses: docker/setup-buildx-action@v3
         - name: Build image
           uses: docker/build-push-action@v6
           with:
             context: .
             file: ops/Dockerfile
             push: false
             tags: gameops/app:ci
             cache-from: type=gha
             cache-to: type=gha,mode=max
   ```

---

## Acceptance Criteria

* Running `docker build -t gameops/app:dev -f ops/Dockerfile .` **succeeds**.
* `docker run --rm -p 8080:8080 -e ASPNETCORE_URLS=http://+:8080 gameops/app:dev` starts and logs include a line like: *Now listening on: [http://0.0.0.0:8080/](http://0.0.0.0:8080)*.
* `docker compose up --build -d` brings up the `app` service and it responds on `http://localhost:8080` (any non‑5xx response is acceptable at this stage).
* `README.md` Quickstart shows the **actual** Docker & Compose commands (no placeholders).
* (If implemented) `Docker Build (PR)` workflow is **green** on a sample PR.

---

## Evidence

* `ops/Dockerfile`
* `.dockerignore`
* `compose.yaml` (or `docker-compose.yml`)
* `README.md` diff replacing the placeholder
* (Optional) `.github/workflows/docker.yml` + link to a green run

---

## Risks & Mitigations

* **Image size / slow builds:** Multi‑stage + restore‑layer caching; enable Buildx cache on CI.
* **Port conflicts (8080):** Allow overriding with `-p <host>:8080` or compose `ports` change.
* **Secrets baked into image:** Never copy local `.env`; keep config via env vars or secret manager (future OIDC/Key Vault integration).

---

## Notes

* When project name changes, update the `ENTRYPOINT` DLL accordingly.
* We keep `PublishTrimmed` off at M0 for faster iteration; can revisit at M2+.
