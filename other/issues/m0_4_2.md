# M0-4-2 — IdempotencyKey filter (endpoint-level)

**Milestone:** M0 — Scaffold & MVP Endpoints
**Labels:** `type:feature`, `area:api`, `area:validation`, `priority:P1`

---

## Mini-lesson (short)

* **Middleware** runs for every request; great for cross-cutting concerns, too broad for a single route.
* **Endpoint filters** wrap only selected routes/groups.
* Goal: validate `Idempotency-Key`, normalize, and pass the value to the handler without scattering logic.

---

## Description

Introduce an `IdempotencyKeyFilter` for the `/events` route group. The filter verifies presence and non-emptiness of the `Idempotency-Key` header, normalizes the value, exposes it via `HttpContext.Items`, and makes it available as a strongly-typed parameter through a lightweight binder (`IdempotencyKey`). Missing/invalid header must result in a **400** `ProblemDetails`. The handler should receive the key explicitly in its signature.

---

## Tasks

1. Implement `IdempotencyKeyFilter` (validate, normalize, store in `HttpContext.Items`).
2. Add a lightweight binder `IdempotencyKey` (reads from `Items`, falls back to header when present).
3. Group endpoints under `/events` and attach the filter only to this group.
4. Update the `POST /events` handler signature to accept `IdempotencyKey`.
5. Remove/disable any previous ad‑hoc header checks in the handler (avoid duplication).
6. Add unit tests for the filter (missing, empty, valid header) and for the happy path.
7. Update README with a short note and example call including `Idempotency-Key`.

---

## Acceptance Criteria

* `POST /events` **without** `Idempotency-Key` returns **400** in `ProblemDetails` format.
* With a valid header the handler executes and receives the key as a parameter.
* The filter applies **only** to `/events` routes (not globally).
* Tests pass locally and in CI.

---

## Evidence

* `src/App/Http/IdempotencyKeyFilter.cs`
* `src/App/Http/IdempotencyKey.cs` (binder)
* `src/App/Endpoints/Events.cs` / `Program.cs`
* README section for `Idempotency-Key`

---

## Risks & Mitigations

* **Scope too broad** → attach the filter only to the `/events` group.
* **Multiple header values** → take the first value; document the expectation of a single value.
* **Inconsistent error messages** → unify `ProblemDetails.Title` for 400 responses.

---

## Hint Ladder

* **Hint 1:** Use `MapGroup("/events")` and attach the filter to the group, not the whole app.
* **Hint 2:** Prefer a binder (`IdempotencyKey`) so the handler receives a strongly‑typed parameter rather than reading `HttpContext.Items` directly.

